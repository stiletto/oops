CC = @CC@
LIBS = @LIBS@
LDFLAGS = @LDFLAGS@
INSTALL = @INSTALL@ @SETOWNER@
INSTALL_DATA = @INSTALL@ -m 644 @SETOWNER@
CHOWN = @CHOWN@

SRCS = oops.c lib.c run.c run_client.c common.c http_utils.c ftp_utils.c \
	storage.c garbage_c.c  icp.c acl.c y.tab.c lex.yy.c \
	rotate_logs.c clean_disk.c ssl.c list.c modules.c \
	worker.c queue.c hash.c gnu_regex.c
OBJS = oops.o lib.o run.o run_client.o common.o http_utils.o ftp_utils.o \
	storage.o garbage_c.o  icp.o acl.o statistics.o list.o \
	rotate_logs.o clean_disk.o ssl.o y.tab.o lex.yy.o modules.o \
	worker.o queue.o hash.o gnu_regex.o

SRCS+=@STRTOKSRC@
OBJS+=@STRTOKOBJ@

#CFLAGS = -Wall -ggdb -D_REENTRANT -D_POSIX_PTHREADS_SEMANTICS

CFLAGS = @CFLAGS@

VER=@VER@
OOPSPATH=@prefix@/oops

.c.o:
	${CC} -c ${CFLAGS} ${CDEFS} $<

all:	oops
	cd modules; make

oops:	${OBJS}
	${CC} ${CFLAGS} ${OBJS} ${LIBS} ${LDFLAGS} -o oops

mkinstalldirs:
	../mkinstalldirs ${OOPSPATH} ${OOPSPATH}/logs ${OOPSPATH}/DB ${OOPSPATH}/storages ${OOPSPATH}/tables ${OOPSPATH}/modules
	if [ "X@OOPS_USER@" != "X" ]; then\
		${CHOWN} @OOPS_USER@ ${OOPSPATH};\
		${CHOWN} @OOPS_USER@ ${OOPSPATH}/logs;\
		${CHOWN} @OOPS_USER@ ${OOPSPATH}/DB;\
		${CHOWN} @OOPS_USER@ ${OOPSPATH}/storages;\
		${CHOWN} @OOPS_USER@ ${OOPSPATH}/tables;\
		${CHOWN} @OOPS_USER@ ${OOPSPATH}/modules;\
	fi

install: all mkinstalldirs
	$(INSTALL) oops ${OOPSPATH}
	if [ -f ${OOPSPATH}/oops.cfg ]; then\
		$(INSTALL_DATA) oops.cfg ${OOPSPATH}/oops.cfg.sample ;\
	   else\
		$(INSTALL_DATA) oops.cfg ${OOPSPATH}/oops.cfg ;\
	fi
	if [ -f ${OOPSPATH}/err_template.html ]; then\
		$(INSTALL_DATA) err_template.html ${OOPSPATH}/err_template.html.sample ;\
	   else\
		$(INSTALL_DATA) err_template.html ${OOPSPATH}/err_template.html ;\
	fi
	if [ -f ${OOPSPATH}/auth_template.html ]; then\
		$(INSTALL_DATA) auth_template.html ${OOPSPATH}/auth_template.html.sample ;\
	   else\
		$(INSTALL_DATA) auth_template.html ${OOPSPATH}/auth_template.html;\
	fi
	if [ -f ${OOPSPATH}/passwd ]; then\
		$(INSTALL_DATA) passwd ${OOPSPATH}/passwd.sample ;\
	   else\
		$(INSTALL_DATA) passwd ${OOPSPATH}/passwd ;\
	fi
	if [ -f ${OOPSPATH}/redir_rules ]; then\
		$(INSTALL_DATA) redir_rules ${OOPSPATH}/redir_rules.sample ;\
	   else\
		$(INSTALL_DATA) redir_rules ${OOPSPATH}/redir_rules ;\
	fi
	if [ -f ${OOPSPATH}/redir_template.html ]; then\
		$(INSTALL_DATA) redir_template.html ${OOPSPATH}/redir_template.html.sample ;\
	   else\
		$(INSTALL_DATA) redir_template.html ${OOPSPATH}/redir_template.html ;\
	fi
	if [ -f ${OOPSPATH}/accel_maps ]; then\
		$(INSTALL_DATA) accel_maps ${OOPSPATH}/accel_maps.sample ;\
	   else\
		$(INSTALL_DATA) accel_maps ${OOPSPATH}/accel_maps ;\
	fi
	if [ -f ${OOPSPATH}/acl_local_networks ]; then\
		$(INSTALL_DATA) acl_local_networks ${OOPSPATH}/acl_local_networks.sample ;\
	   else\
		$(INSTALL_DATA) acl_local_networks ${OOPSPATH}/acl_local_networks ;\
	fi
	if test "X@SOFLAGS@" != "X"; then \
	for m in modules/*so ; do \
		$(INSTALL) $$m ${OOPSPATH}/modules ; \
	done; \
	$(INSTALL) modules/oopsctl ${OOPSPATH}; \
	fi
	for t in tables/*.tab ; do \
		$(INSTALL_DATA) $$t ${OOPSPATH}/tables ; \
	done

oops.o:		oops.c oops.h version.h
lib.o:		lib.c oops.h
run.o:		run.c oops.h
run_client.o:	run_client.c oops.h modules.h
http_utils.o:	http_utils.c oops.h
ftp_utils.o:	ftp_utils.c oops.h
garbage_c.o:	garbage_c.c oops.h
acl.o:		acl.c oops.h
malloc.o:	malloc.c
storage.o:	storage.c oops.h
icp.o:		icp.c oops.h
rotate_logs.o:	rotate_logs.c oops.h
clean_disk.o:	clean_disk.c oops.h
ssl.o:		ssl.c oops.h
statistics.o:	statistics.c oops.h
list.o:		list.c llt.h oops.h
modules.o:	modules.c modules.h oops.h
common.o:       common.c oops.h

version.h:	version
		echo "#define VERSION \""`cat version`"\""> version.h

lex.yy.o: lex.yy.c y.tab.h oops.h
	${CC} ${CFLAGS} ${CDEFS} -c lex.yy.c

lex.yy.c: parser.l
	@LEX@ parser.l

y.tab.c: parser.y
	@YACC@ -d parser.y

y.tab.o: y.tab.c oops.h
	${CC} ${CFLAGS} ${CDEFS} -c y.tab.c

malloc.o: malloc.c
	${CC} ${CFLAGS} ${CDEFS} -DEBUG -c malloc.c

gnu_regex.o: gnu_regex.c
	${CC} ${CFLAGS} -DREGEX -c gnu_regex.c

clean:
	rm -f *o lex.yy.c  y.tab.[ch] version.h oops

cleandist:
	rm -f Makefile *o lex.yy.c  y.tab.[ch] *~ *.ln config.cache version.h oops

lint:
	lint -Ncheck=%all -Nlevel=4 ${CFLAGS} ${SRCS}
